<!--
author: Dailyscat
purpose: issue arrange
rules:
 (1) 헤더와 문단사이
    <br/>
    <br/>
 (2) 코드가 작성되는 부분은 >로 정리
 (3) 참조는 해당 내용 바로 아래
    <br/>
    <br/>
 (4) 명령어는 bold
 (5) 방안은 ## 안의 과정은 ###
-->

# Issue:

<br/>
<br/>

Next.js 배포 환경에서 서버 측 `fetch` 호출 시 `ECONNREFUSED 127.0.0.1:3000` 에러 발생
(prod에서 API 요청이 전부 터지는 상황)

## 상황:

<br/>
<br/>

- Next.js 앱 배포 후, 실제 서버에서 페이지 진입 시마다 에러
- 스택 트레이스 상으로는 SSR/RSC 쪽에서 `fetch` 호출하다가 실패
- 에러 로그 요약

> TypeError: fetch failed
> [cause]: Error: connect ECONNREFUSED 127.0.0.1:3000

- 로컬(dev)에서는 정상 동작
- `.env.production`이랑 `.env.local`을 따로 쓰고 있는데, 리얼에서 `.env.local` 값이 섞여 들어온 정황

## 생각해낸 방안:

<br/>
<br/>

- prod에서는 **localhost:3000** 절대 안 쓰게 만들 것 (도메인/상대경로로 통일)
- `.env.local`이 prod 설정을 덮어쓰지 않도록 정리
- Next 자체 API(route handlers) 호출은 최대한 **상대 경로**(`/api/...`)로 처리

## 방안:

<br/>
<br/>

### 1. env 파일 정리

<br/>
<br/>

- 개발용 / 실서버용 env 분리 기준 다시 잡기

  - dev:

    - `.env.development.local` 또는 로컬 전용 `.env.local`에 개발용 값

  - prod:

    - 서버 환경 변수 또는 `.env.production(.local)` 에 실서버 값만 넣기

- prod 환경에서는 **API 관련 키가 들어간 `.env.local` 파일 자체를 안 올리거나**, 해당 키를 제거
- 현재 사용하는 키 예시 (실제 호스트명은 제거)

> NEXT_PUBLIC_API_BASE_URL
> API_BASE_URL

- 이 키들이 prod에서 `http://localhost:3000` 같은 값 안 가지도록 점검

### 2. localhost 직접 호출 제거

<br/>
<br/>

- 코드 전역 검색

> "localhost:3000"
> "127.0.0.1:3000"

- 발견되는 부분들 전부 수정

  - 외부/별도 API 서버라면
    → `process.env.NEXT_PUBLIC_API_BASE_URL` 기반으로 호출
  - 같은 Next 앱의 `/api` 라우트라면
    → `fetch('/api/xxx')` 처럼 **상대 경로**로 호출

예시:

> const baseURL = process.env.NEXT_PUBLIC_API_BASE_URL;
> await fetch(`${baseURL}/api/xxx`);

혹은

> await fetch('/api/xxx');

### 3. prod에서 실제로 어떤 값이 들어오는지 확인

<br/>
<br/>

- 배포된 환경에서 env 값 한 번 찍어보기 (로그만 잠깐 추가했다가 롤백)

  - 서버 로그에 `process.env.NEXT_PUBLIC_API_BASE_URL` 등 출력해서
  - prod에서 진짜 어떤 값이 쓰이는지 확인

- 만약 여기서도 `localhost`가 찍히면

  - `.env.local` / 플랫폼 환경 변수 중 어디서 가져오는지 다시 추적

### 4. 배포 파이프라인 쪽 정리

<br/>
<br/>

- 빌드/배포 과정에서

  - dev용 env 파일이 포함돼서 올라가는지 확인
  - 필요하면 **빌드 시점에만 쓰는 env** / **런타임 env** 분리

- 컨테이너/서버에서 env 주입을 한 곳에서만 관리하도록 정리해서

  - 같은 키에 dev/prod 값이 섞이지 않게 정돈

<br/>
<br/>
<br/>
<br/>

```
    참조:
```

<br/>

- Next.js 환경 변수 로딩 순서 문서 (env 파일 우선순위 확인용)
- 배포 환경(플랫폼)에서 제공하는 env 관리 기능 가이드 (환경 변수 설정 방식 확인용)
