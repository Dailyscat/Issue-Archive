<!-- author: Dailyscat purpose: issue arrange rules: (1) 헤더와 문단사이 <br/> <br/> (2) 코드가 작성되는 부분은 >로 정리 (3) 참조는 해당 내용 바로 아래 <br/> <br/> (4) 명령어는 bold (5) 방안은 ## 안의 과정은 ### -->

Issue:
<br/> <br/>
상황:
<br/> <br/>

배포 스크립트에서 www 계정이 ssh로 irteam 계정에 접속해서 명령을 실행하려고 했는데,
처음엔 “호스트 신뢰(yes/no)”가 뜨고, 그 다음엔 irteam 비밀번호를 요구해서 자동 실행이 막힘.

<br/> <br/>

추가로 .ssh/ 아래에 authorized_keys, authorized_keys2 같은 파일이 여러 개 있고,
키 파일 이름(id_ed25519, \*.pub)도 뭘 써야 하는지 헷갈렸음.

<br/> <br/>

참조:

<br/>

known_hosts(호스트 신뢰)와 authorized_keys(사용자 인증)는 역할이 다름

ssh는 “공개키 파일 이름”이 아니라 “개인키 파일”을 자동 탐색함

서버가 읽는 authorized keys 파일은 sshd 설정에 따라 정해짐

<br/> <br/>
생각해낸 방안:
<br/> <br/>

host 신뢰(yes/no)는 known_hosts를 미리 채우거나 옵션으로 처리

비밀번호 프롬프트는 www 공개키를 irteam의 authorized_keys에 등록해서 해결

authorized_keys2는 환경에 따라 안 읽힐 수 있어서 기본은 authorized_keys를 사용

<br/> <br/>
방안:
<br/> <br/>

1. .ssh/authorized_keys, authorized_keys2 정리
   <br/> <br/>

서버가 “공개키로 로그인 허용”할 때 읽는 파일은 아무 파일이나가 아니라 sshd 설정에 등록된 파일만 읽음

기본적으로는 ~/.ssh/authorized_keys를 보는 경우가 대부분

authorized_keys2는 레거시로 같이 읽게 설정된 서버도 있지만, 요즘은 안 읽는 환경도 있음

<br/> <br/>

확인 명령(가능하면)
sshd -T | grep -i authorizedkeysfile
또는
grep -i '^AuthorizedKeysFile' /etc/ssh/sshd_config

<br/> <br/>

참조:

<br/>

AuthorizedKeysFile 값에 들어있는 경로만 sshd가 참고함

여러 키는 파일을 여러 개 만드는 게 아니라, authorized_keys에 여러 줄로 넣는 방식이 일반적

<br/> <br/> 2) .ssh 아래 공개키/개인키 파일 이름 정리
<br/> <br/>

SSH가 “자동으로 찾는 것”은 .pub가 아니라 개인키(private key) 파일임

기본적으로 ssh는 아래 같은 개인키 파일들을 자동으로 탐색함

~/.ssh/id_ed25519

~/.ssh/id_rsa

(기타 id_ecdsa 등)

<br/> <br/>

~/.ssh/id_ed25519.pub 같은 공개키 파일은 “서버에 등록할 때 쓰는 원본 텍스트”라서,
파일 이름 자체는 크게 중요하지 않음
(어차피 서버는 .pub 파일을 읽는 게 아니라 authorized_keys 안의 내용을 읽음)

<br/> <br/>

키 파일 확인
ls -la ~/.ssh

키를 기본 이름이 아닌 걸로 쓰면
ssh -i ~/.ssh/내키이름 user@host

<br/> <br/>

참조:

<br/>

자동 인증은 “개인키를 가지고 서명”해서 성립함

공개키는 서버의 authorized_keys에 들어가서 “서명 검증용”으로 쓰임

<br/> <br/> 3) (정리) www -> irteam 패스워드 프롬프트 없애기
<br/> <br/>

www가 ssh 클라이언트이므로, www의 공개키가 필요

ssh로 로그인되는 대상 계정이 irteam이므로, **irteam의 ~/.ssh/authorized_keys**에 등록해야 함

<br/> <br/>

www 공개키 생성(없으면 생성)
su - www
mkdir -p ~/.ssh && chmod 700 ~/.ssh
ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N ""
cat ~/.ssh/id_ed25519.pub

(출력된 한 줄을 복사)

<br/> <br/>

irteam authorized*keys에 추가(append)
su - irteam
mkdir -p ~/.ssh && chmod 700 ~/.ssh
echo "여기에*복사한*공개키*한줄" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

<br/> <br/>

참조:

<br/>

password 프롬프트는 “사용자 인증” 문제 → authorized_keys로 해결

yes/no 프롬프트는 “호스트 신뢰” 문제 → known_hosts로 해결

<br/> <br/> <br/> <br/>

참조:

<br/>

sshd가 읽는 authorized keys 파일: AuthorizedKeysFile (sshd_config / sshd -T)

ssh가 자동으로 찾는 키: 개인키(id_ed25519 등), .pub는 보관/등록용

서버는 .pub 파일명을 보는 게 아니라 authorized_keys 안의 “키 내용”을 읽어서 인증함
