# Issue:

Next.js로 마이그레이션하면서 `recommend_seller` 템플릿(홈/스페셜) + 쇼핑 탭 쪽 `RecommendSeller`에서 이미지 처리 때문에 섹션이 통째로 안 보이는 문제까지 같이 정리.

## 상황:

- 예전 Freemarker 템플릿 `recommend_seller.ftl` 기준으로 React 컴포넌트(`src/components/mobile/templates/RecommendSeller.tsx`)가 제대로 옮겨져 있는지 확인할 필요가 있었음
- 최대 12개 노출 + “더보기” 버튼 동작이 Freemarker와 동일해야 했고, 필요하면 12개라는 숫자를 바꿀 수 있게 만들고 싶었음
- 한편, 다른 경로의 컴포넌트인 `src/components/mobile/shop/RecommendSeller.tsx`(쇼핑 탭용)에서 이미지 쪽에 문제가 생기면 섹션 전체가 안 보이는 현상이 있어서, 어디서 그렇게 동작하는지 원인 파악이 필요했음

<br/>
<br/>

## 알게된 부분 정리:

- Freemarker `recommend_seller.ftl`은
  - 추천 셀러를 **최초 12개만 노출**, 그 이후 셀러는 DOM에는 있지만 `display:none` 으로 숨겨둠
  - 셀러가 12개 초과일 때만 “더보기” 버튼을 노출하고, 버튼 클릭 시 숨겨둔 `_hide_seller_item`들을 보여주면서 버튼은 사라지는 구조
- React 템플릿 버전 `src/components/mobile/templates/RecommendSeller.tsx`는
  - 템플릿의 `sellerMapping`에서 ID 배열을 뽑아서 `useGetSellersByIds`로 셀러 정보를 가져옴 (서버에서 `getSellers` 하던 것과 동등한 개념)
  - 최초 노출 개수를 하드코딩했던 `12`를 `maxVisibleCount` prop으로 바꾸고, 기본값을 12로 둠 → Freemarker와 기본 동작은 같고, 필요하면 화면별로 숫자만 조절 가능
- 쇼핑 탭용 `src/components/mobile/shop/RecommendSeller.tsx`는
  - 데이터가 비었을 때는 `isEmptyRecommendSellers`로 아예 섹션을 렌더하지 않음
  - 데이터는 있는데 “이미지 표현이 잘못된 경우” 섹션 전체가 안 보이는 현상은, 이 컴포넌트가 숨기는 게 아니라 **하위 `SellerCard` 안의 `<Image>` 컴포넌트가 런타임에서 터지면서 전체 섹션이 같이 날아가는 것**으로 정리됨

<br/>
<br/>

## 개념: Freemarker `recommend_seller.ftl`과 React 템플릿 매핑

<br/>
  Freemarker 템플릿이 어떻게 동작하는지 먼저 다시 정리:

- 템플릿/셀러 조회

  > ```ftl
  > <#assign template=templateModel.getTemplateById("recommend_seller")/>
  > <#assign sellers=templateModel.getSellers("recommend_seller",template.no)>
  > ```

- 레이아웃/타이틀

  > ```ftl
  > <div class="hot_brand <#if __screenName__ == "Top">frame_bg</#if> __20181120002">
  >   <div class="title_wrap">
  >     <h2 class="title">${xltDefaultTitle}</h2>  <#-- txt.rc.shop -->
  >   </div>
  >   <div class="item_list type3x">
  >     ...
  >   </div>
  > </div>
  > ```

- 12개 제한 + 더보기

  > ```ftl
  > <#list sellers as seller>
  >   <li <#if (seller_index > 11) >
  >        class="itm _hide_seller_item" style="display: none;"
  >      <#else>
  >        class="itm"
  >      </#if>
  >   > ... </li>
  > </#list>
  >
  > <#if (sellers?size > 12)>
  >   <div class="btn_more_wrap">
  >     <button class="btn_more" ...
  >       common-show-action="_hide_seller_item"
  >       common-self-close-action
  >     ></button>
  >   </div>
  > </#if>
  > ```

- 인기(베스트) 셀러 마크:

  > ```ftl
  > <#if templateModel.fixedContents.top_seller?has_content
  >   && templateModel.fixedContents.top_seller.top5SellerNoSet??
  >   && templateModel.fixedContents.top_seller.top5SellerNoSet.contains(seller.sellerNo)>
  >   <span class="ico_best">人気</span>
  > </#if>
  > ```

이걸 React 쪽에서 어떻게 맞췄는지:

- 템플릿 기반 컴포넌트 `src/components/mobile/templates/RecommendSeller.tsx` 에서

  > ```tsx
  > interface RecommendSellerProps {
  >   isTopScreen?: boolean;
  >   moreBtnType: 'single' | 'arrow';
  >   template: RestTemplate;
  >   top5SellerNoSet?: number[];
  >   /** 최초 노출할 셀러 개수 (기본값 12) */
  >   maxVisibleCount?: number;
  > }
  >
  > export default function RecommendSeller({
  >   isTopScreen = false,
  >   moreBtnType,
  >   template,
  >   top5SellerNoSet,
  >   maxVisibleCount = 12
  > }: RecommendSellerProps) {
  >   const [isShowMore, setIsShowMore] = useState(false);
  >   const [showSellers, setShowSellers] = useState<testThumbnailSeller[]>([]);
  >   const sellerIds = useMemo(
  >     () => (template?.sellerMapping ?? []) as number[],
  >     [template]
  >   );
  >   const { data } = useGetSellersByIds(sellerIds);
  >   const sellersByRecommendSeller = (data?.result ?? []) as testThumbnailSeller[];
  >
  >   useEffect(() => {
  >     if (!sellersByRecommendSeller.length) {
  >       setShowSellers([]);
  >       setIsShowMore(false);
  >       return;
  >     }
  >
  >     if (sellersByRecommendSeller.length > maxVisibleCount) {
  >       const result = sellersByRecommendSeller.slice(0, maxVisibleCount);
  >       setShowSellers(result);
  >       setIsShowMore(true);
  >     } else {
  >       setShowSellers(sellersByRecommendSeller);
  >       setIsShowMore(false);
  >     }
  >   }, [sellersByRecommendSeller, maxVisibleCount]);
  >
  >   const handleBtnMore = () => {
  >     setIsShowMore(false);
  >     setShowSellers(sellersByRecommendSeller);
  >   };
  >
  >   ...
  > }
  > ```

- 최초 12개 노출 + 12개 초과 시 더보기 버튼 + 버튼 한 번 누르면 전체 노출, 버튼 사라지는 동작까지 Freemarker와 동일하게 맞췄고
- 숫자 `12`만 `maxVisibleCount`로 빼서 화면마다 조절 가능하게 만든 정도만 차이
- BEST(人気) 마크는 `ItemListType` 안에서 `top5SellerNoSet` 기준으로 렌더해서 Freemarker와 동일하게 표시

<br/>
<br/>
<br/>

        참조:
        - `/Users/user/Documents/testplus/test/lcp-test-box/lcp-test-sakura/src/main/resources/freemarker/view/partner/templates/recommend_seller.ftl`
        - `src/components/mobile/templates/RecommendSeller.tsx`
        - `src/components/mobile/common/ItemListType.tsx`

<br/>

## 개념: Next.js `<Image>`와 잘못된 src가 섹션 전체를 죽이는 이유

<br/>
  쇼핑 탭 쪽 `src/components/mobile/shop/RecommendSeller.tsx`에서, “이미지 표현이 뭔가 꼬이면 섹션이 통째로 안 보인다” 라는 느낌이 나는 이유를 정리.

먼저 RecommendSeller(shop) 쪽 코드를 보면, 렌더 조건은 정말 단순하다.

> ```tsx
> const isEmptyRecommendSellers =
>   !recommendSellers || recommendSellers.length === 0;
>
> return (
>   <div className='main_section_wrap'>
>     {!isEmptyRecommendSellers && (
>       <section className='main_section'>
>         ...
>         {recommendSellers.map((seller, index) => (
>           <SwiperSlide key={seller.sellerNo} ...>
>             <SellerCard
>               type='default'
>               seller={seller}
>               section={'recommend'}
>               index={index}
>               listSize={recommendSellers.length}
>               shopCategoryMapById={shopCategoryMapById}
>             />
>           </SwiperSlide>
>         ))}
>       </section>
>     )}
>     ...
>   </div>
> );
> ```

여기서 “이미지 안 나오면 숨긴다” 같은 조건은 없음. 그러면 실제로 섹션이 통째로 안 보이는 건 렌더조건이 아니라 **런타임 에러** 때문이다.

그 에러가 어디서 터지느냐가 핵심인데, 결국 `SellerCard` 안의 Next `<Image>` 사용 방식 때문이라고 보는 게 맞음.

> ```tsx
> // src/components/mobile/shop/SellerCard.tsx
>
> <Image
>   src={getRecommendImageUrl(seller) || ''}
>   alt=''
>   width={0}
>   height={0}
>   sizes='100vw'
>   style={{ width: '100%', height: 'auto' }}
> />
> ...
> <Image
>   src={getFullImageURl('w', 318, getProfileImageUrl(seller))}
>   width={38}
>   height={38}
>   alt={seller.displayName}
> />
> ```

`getFullImageURl` 구현을 보면, 이미지 URL이 비었을 때 어떻게 처리하는지 나오는데:

> ```ts
> // src/utils/imageUtils.ts
>
> const getFullImageURl = (
> 	prefix: string,
> 	widthSize: number,
> 	imageUrl?: string,
> ) => {
> 	const isObsImage =
> 		imageUrl?.includes('obs') || imageUrl?.includes('shopping.test-scdn.net');
>
> 	if (!imageUrl || imageUrl.length === 0) {
> 		return '';
> 	}
>
> 	return `${imageUrl ?? ''}${
> 		isObsImage ? `/${prefix}${widthSize}` : `?type=${prefix}${widthSize}`
> 	}`;
> };
> ```

- `imageUrl` 이 `undefined` 이거나 빈 문자열이면 그냥 `''`(빈 문자열)를 반환
- 그걸 `<Image src={''} ... />` 로 넘기게 됨

Next.js 의 `<Image>` 컴포넌트는 `src` 가 비정상(빈 문자열, 형식 안 맞는 값 등)이면 **런타임에서 예외를 던진다.**

- 일반 `<img src="">` 같으면 그냥 깨진 이미지 아이콘 정도로 끝났을 상황인데,
- Next의 `<Image>` 는 아예 에러를 던져서 해당 컴포넌트 렌더를 중단시키고, 그게 상위 트리까지 전파됨 → `SellerCard` 가 들어간 그 섹션 전체가 안 보이는 것처럼 보이게 됨.

반대로, 템플릿 계열(`ItemListType`)에서는 같은 `getFullImageURl`을 쓰지만, 미리 `imageUrl`을 검사해서 비어 있으면 그 셀러를 **렌더 대상에서 빼는** 식으로 방어를 하고 있어서, `<Image src=''>` 같은 상황이 거의 안 생김.

> ```ts
> // src/components/mobile/common/ItemListType.tsx
>
> const itemsWithIndex = useMemo(() => {
> 	const result: Map<number, ItemType> = new Map();
> 	sellers.forEach((seller, i) => {
> 		const imageURl = getImageUrlPath(i);
> 		if (imageURl.length > 0 && !!seller) {
> 			result.set(i, seller);
> 		}
> 	});
> 	return result;
> }, [sellers]);
> ```

그래서 정리하면:

- **쇼핑 RecommendSeller 섹션이 통째로 사라지는 느낌** → RecommendSeller가 조건으로 숨기는 게 아니라, 하위 `SellerCard`에서 `<Image src=''>` 때문에 런타임 에러가 나서 섹션 렌더가 깨지는 것
- Freemarker 템플릿/React 템플릿 쪽은 이미지 URL이 비면 아예 그 셀러를 스킵해버려서, 섹션 전체가 사라지진 않음

<br/>
<br/>
<br/>

        참조:
        - `src/components/mobile/shop/RecommendSeller.tsx`
        - `src/components/mobile/shop/SellerCard.tsx`
        - `src/utils/imageUtils.ts`

<br/>

## 방안:

### 1. `recommend_seller` 템플릿 쪽 (홈/스페셜)

- Freemarker 템플릿과 동작을 맞추는 걸 우선으로 보고,
  - 최초 노출 개수: 12개
  - 12개 초과 시에만 “더보기” 버튼 노출
  - 버튼 한 번 누르면 나머지 전부 노출 + 버튼은 사라짐
- 여기에 숫자 `12`만 하드코딩에서 빼서 `maxVisibleCount` prop으로 노출
  - 기본값은 12로 두고, 화면마다 필요하면

    > ```tsx
    > <RecommendSeller
    > 	isTopScreen
    > 	moreBtnType="arrow"
    > 	template={recommendSellerTemplate}
    > 	top5SellerNoSet={top5SellerNoSet}
    > 	maxVisibleCount={8} // 예: 홈에서는 8개만 먼저 노출
    > />
    > ```

  - 이런 식으로 개별 튜닝 가능하게 열어둠

- BEST 마크, `frame_bg` 클래스(`isTopScreen`), `type3x` 레이아웃 등은 Freemarker 기준 그대로 가져옴

### 2. 쇼핑 RecommendSeller / SellerCard 쪽

- 근본 원인은 `SellerCard`의 `<Image>` 가 **잘못된 src를 그대로 받는 구조**라서, 이 부분에 안전장치를 두는 게 맞음
- 선택지는 크게 세 가지 정도로 볼 수 있음:
  1. `SellerCard`에서 src가 비면 `<Image>` 자체를 렌더하지 않기

     > ```tsx
     > const profileSrc = getFullImageURl('w', 318, getProfileImageUrl(seller));
     >
     > ...
     > {profileSrc && (
     >   <Image
     >     src={profileSrc}
     >     width={38}
     >     height={38}
     >     alt={seller.displayName}
     >   />
     > )}
     > ```

  2. `getFullImageURl` 에 fallback 이미지를 하나 정해두고, 빈 값이면 그걸 반환

     > ```ts
     > const FALLBACK_IMAGE =
     > 	'https://test.test-test.net/test-image-jp/test/market_jp/pc/img-error.svg';
     >
     > const getFullImageURl = (
     > 	prefix: string,
     > 	widthSize: number,
     > 	imageUrl?: string,
     > ) => {
     > 	const isObsImage =
     > 		imageUrl?.includes('obs') ||
     > 		imageUrl?.includes('shopping.test-test.net');
     >
     > 	if (!imageUrl || imageUrl.length === 0) {
     > 		return FALLBACK_IMAGE;
     > 	}
     >
     > 	return `${imageUrl ?? ''}${
     > 		isObsImage ? `/${prefix}${widthSize}` : `?type=${prefix}${widthSize}`
     > 	}`;
     > };
     > ```

  3. 이 부분만 `<img>` 로 바꾸고, src가 잘못되면 그냥 깨진 이미지로만 보이게 두기 (런타임 에러를 막기 위한 타협안)

- 어떤 쪽이든 공통 포인트는
  - **Next `<Image>` 에는 절대 빈 문자열 같은 비정상 src를 보내지 않는다**
  - 문제가 있는 셀러 하나 때문에 섹션 전체가 사라지지 않게 “셀러 단위로만 실패” 하도록 분리하는 것

<br/>
<br/>
