<!-- author: Dailyscat purpose: issue arrange rules: (1) 헤더와 문단사이 <br/> <br/> (2) 코드가 작성되는 부분은 >로 정리 (3) 참조는 해당 내용 바로 아래 <br/> <br/> (4) 명령어는 bold (5) 방안은 ## 안의 과정은 ### -->

Issue: m2 디펜던시 깨져서 잘되던 젠킨스 배포 안됨
<br/> <br/>
상황:
<br/> <br/>

[ERROR] Failed to execute goal com.github.eirslett:frontend-maven-plugin:1.3:install-node-and-npm (install node and npm) on project front-admin-static: Could not extract the Node archive: Could not extract archive: '/home/jenkins/.m2/repository/com/github/eirslett/node/10.6.0/node-10.6.0-linux-x64.tar.gz': EOFException -> [Help 1]
[ERROR]
[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.
[ERROR] Re-run Maven using the -X switch to enable full debug logging.
[ERROR]
[ERROR] For more information about the errors and possible solutions, please read the following articles:
[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/MojoFailureException

<br/> <br/>
알게된 부분 정리:
<br/> <br/>

실패 지점은 frontend-maven-plugin의 node 설치 단계였고, /home/jenkins/.m2/.../node-10.6.0-linux-x64.tar.gz 압축을 푸는 과정에서 EOFException이 났음

EOFException은 보통 “파일이 끝까지 안 받아졌거나(중간에 끊김), 깨진 파일”일 때 많이 뜸

이번 케이스는 agent2에서만 재현됐고, agent2의 .m2 캐시에 깨진 tar.gz가 남아있던 상태였음

<br/> <br/>
개념: EOFException (압축 해제 중)
<br/> tar.gz 같은 아카이브 파일을 푸는 도중 `EOFException`이 뜨면, 대부분 “정상 파일이 아니라서” 생김. 다운로드가 중간에 끊겼는데 캐시에 그대로 저장되거나, 파일이 손상/잘림 상태로 남아있을 때 주로 발생한다. Maven은 `.m2`에 한번 받아둔 파일을 재사용하니까, 한 번 깨진 파일이 들어가면 이후 빌드도 계속 같은 방식으로 터질 수 있음. <br/> <br/> <br/>
참조:

<br/> <br/> http://cwiki.apache.org/confluence/display/MAVEN/MojoFailureException <br/> <br/>
해결 방안: agent2의 깨진 m2 캐시 정리 후 재빌드
<br/> <br/>

1. agent2 파드 접속
   <br/> <br/>

kubectl exec -n jenkins -it jenkins-agent2-8456f98468-8cd62 -- bash

<br/> <br/> 2) 깨진 Node 아카이브 및 디렉토리 삭제
<br/> <br/>

rm -f /home/jenkins/.m2/repository/com/github/eirslett/node/10.6.0/node-10.6.0-linux-x64.tar.gz
rm -rf /home/jenkins/.m2/repository/com/github/eirslett/node/10.6.0

<br/> <br/> 3) (권장) frontend-maven-plugin 관련 캐시까지 같이 정리
<br/> <br/>

rm -rf /home/jenkins/.m2/repository/com/github/eirslett

<br/> <br/> 4) Jenkins 재빌드
<br/> 위 캐시 지우고 다시 돌리니까 node tar.gz를 새로 받아오면서 정상적으로 진행됐고, 배포도 다시 됨. <br/> <br/>
참조:

<br/> <br/> (내부 조치 로그) agent2에서 .m2 캐시 삭제 후 재빌드 성공 <br/> <br/>
추가 메모 (재발 방지용)
<br/> <br/>

같은 증상이 반복되면 .m2가 여러 agent에서 공유되는지(PVC 공유 등) 확인 필요

네트워크가 불안정하면 다운로드가 종종 깨질 수 있어서, 장기적으로는 node를 이미지에 포함하거나 캐시 전략을 정리하는 게 편함
